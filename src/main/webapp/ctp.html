<!DOCTYPE html>
<html>
<head>
    <title>Cryptotrading Places</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="jquery/jquery.css">
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="jquery-ui/css/smoothness/jquery-ui.css">
    <link type="text/css" rel="stylesheet" media="all" href="css/overwrite_jquery.css"/>

    <script src="jquery/jquery-2.1.3.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="bootstrap/js/bootstrap-select.min.js"></script>
    <script src="angular/angular.min.js"></script>
    <script src="jquery-ui/js/jquery-ui.js"></script>
</head>
<body>

<div ng-app="cryptoTrading" ng-controller="cryptoTradingController">
    <div align="center"><h1>Crypto trading places (Handel)</h1></div>

    <div align="center">
        <h3>
            {{tradingAsText}} : {{currentRate}}
        </h3>

    </div>

    <div align="center">
        <div class="btn-group btn-toolbar" role="group">
            <button type="button" class="btn btn-primary" ng-click="reCalculate()"> Herbereken</button>
            <button type="button" class="btn btn-primary" ng-click="getGraph()"> Grafiek</button>
            <button type="button" class="btn btn-primary" ng-click="getWallet()"> Wallet</button>
            <button type="button" class="btn btn-primary" ng-click="getOrders()"> Orders</button>
        </div>
    </div>

    <div ng-show="menuOption == 'showWallet'" align="center">
        <h4>Wallet</h4>
        <table>
            <tr>
                <td width="200"><h4>Munten :</h4></td>
                <td><h4>{{ wallet.coins }} {{ currency.code }}</h4></td>
            </tr>
            <tr>
                <td><h4>Cryptocoins :</h4></td>
                <td><h4>{{ wallet.cryptoCoins }} {{ cryptoCurrency.code }}</h4></td>
            </tr>
        </table>

        <h4>Wallet historie</h4>
        <table>
            <tr>
                <th width="150">Datum en tijd</th>
                <th width="120">Munten</th>
                <th width="130">Crypto munten</th>
                <th width="100">Koers</th>
                <th width="200">Totale waarde</th>
            </tr>
            <tr ng-repeat="walletHistory in walletHistories">
                <td>{{ walletHistory.timestamp | date: "dd-M-yyyy - hh:mm:ss uur" }}</td>
                <td>{{ walletHistory.coins }}</td>
                <td>{{ walletHistory.cryptoCoins }}</td>
                <td>{{ walletHistory.exchangeRate }}</td>
                <td>{{ walletHistory.totalValue }}</td>
            </tr>
        </table>
    </div>

    <div ng-show="menuOption == 'showOrders'" align="center">
        <h4>Market Orders</h4>

        <table>
            <tr>
                <th width="150">Datum en tijd</th>
                <th width="80">Index</th>
                <th width="100">Order type</th>
                <th width="170">Order nummer</th>
                <th width="100">Munten</th>
                <th width="120">Crypto munten</th>
                <th width="120">Koers</th>
                <th width="100">Commissie</th>
                <th width="200">Status</th>
            </tr>
            <tr ng-repeat="order in marketOrders">
                <td>{{ order.timestamp | date: "dd-M-yyyy - hh:mm:ss uur" }}</td>
                <td>{{ order.index }}</td>
                <td>{{ order.type | orderType }}</td>
                <td>{{ order.orderReference }}</td>
                <td>{{ currency.symbol }} {{ order.coins | number: 2}}</td>
                <td>{{ cryptoCurrency.symbol }} {{ order.cryptoCoins | number: 5}}</td>
                <td>{{ order.exchangeRate }} {{ currency.symbol}} / {{ cryptoCurrency.symbol }}</td>
                <td>{{ currency.symbol }} {{ order.fee }}</td>
                <td>{{ order.status | orderStatus }}</td>
            </tr>
        </table>
    </div>

    <div ng-show="menuOption == 'showGraph'" align="center">
        <h4>Grafiek</h4>
    </div>


    <div ng-show="menuOption == 'recalculate'" align="center">
        <h4>Herbereken trends</h4>
        <br/>
        <div id="progressbar" class="progress"><div class="progress-label" align="center">...</div></div>
    </div>

</div>

</body>

<script>

    // Angular filter type for Order Type
    angular.module('orderTypeFilter', []).filter('orderType', function () {
        return function (input) {
            if (input == 'SELL') {
                return 'Verkoop'
            }
            else {
                return 'Koop';
            }
        };
    });

    // Angular filter type for order status
    angular.module('orderStatusFilter', []).filter('orderStatus', function () {
        return function (input) {
            switch (input) {
                case  'EXECUTED'   :
                    return 'Uitgevoerd';
                case  'EXECUTING'  :
                    return 'In uitvoering';
                case  'CANCELLED'  :
                    return 'Afgebroken';
                case  'PARTLYEXEC' :
                    return 'Gedeeltelijk uitgevoerd';
                case  'OPEN'       :
                    return 'Open';
                case  'RETRY'      :
                    return 'Herhaal';
                case  'ERROR'      :
                    return 'Fout opgetreden';
                default :
                    return '-';
            }
        };
    });

    // Register filter
    var app = angular.module("cryptoTrading", ['orderTypeFilter', 'orderStatusFilter']);

    app.controller("cryptoTradingController", function ($scope, $http) {

        $scope.menuOption = "showOrders ";

        // get current trading
        var promise = $http.get('rest/getCurrentTrading').
                success(function (data) {
                    $scope.trading = data;
                });

        // Wait until promise of getting current trade is finished.
        promise.then(function () {

            // get trading site as text
            $http.get('rest/getTradingAsStringText/' + $scope.trading.id).
                    success(function (data) {
                        $scope.tradingAsText = data;
                    });

            // get current crypto trading rate
            $http.get('rest/currentCryptoRate/' + $scope.trading.id).
                    success(function (data) {
                        $scope.currentRate = data;
                    });

            $scope.currency = $scope.trading.tradePair.currency;
            $scope.cryptoCurrency = $scope.trading.tradePair.cryptoCurrency;
        });

        // Get all market orders
        $scope.getOrders = function () {
            $scope.menuOption = "showOrders";

            $http.get('rest/marketOrders/' + $scope.trading.id).
                    success(function (data) {
                        $scope.marketOrders = data;
                    });
        }

        // Get wallet
        $scope.getWallet = function () {
            $scope.menuOption = "showWallet";

            $http.get('rest/getWallet/' + $scope.trading.id).
                    success(function (data) {
                        $scope.wallet = data;
                    });

            $http.get('rest/getWalletHistory/' + $scope.trading.id).
                    success(function (data) {
                        $scope.walletHistories = data;
                    });
        }

        // Show graph
        $scope.getGraph = function () {
            $scope.menuOption = "showGraph";
        }

        // Recalcuate trends
        $scope.reCalculate = function () {

            $scope.menuOption = "recalculate";

            t = setTimeout($scope.progressMonitor, 2000);

            $scope.progress = 0;

            $http.post('rest/recalculate/' + $scope.trading.id);
        }

        // Determine Order Type
        $scope.getOrderType = function (order) {

            if (order instanceof BuyMarketOrder) {
                return "Koop";
            }
            else {
                return "Verkoop";
            }
        }


        // Progress Monitoring (trend calculation)
        $scope.progress = 0;

        var progressbar   = $("#progressbar"),
            progressLabel = $(".progress-label");

         progressbar.progressbar({
                value: false,
                change: function () {
                    progressLabel.text(progressbar.progressbar("value") + "%");
                },
                complete: function () {
                    progressLabel.text("Gereed");
                }
         });

         $scope.progressMonitor = function (){

            var progressbar = $("#progressbar");

            $scope.progress = $scope.progress + 10;

            if($scope.progress > 0){
                progressbar.progressbar( "value", $scope.progress );
            }

            if($scope.progress < 100){
                t = setTimeout($scope.progressMonitor, 2000);
            }
        };
    })

</script>

</html>